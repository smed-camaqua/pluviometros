const t=new RainDataAPI('https://31fbdc764107.ngrok-free.app'),u=new URLSearchParams(window.location.search);let o;window.ondragstart=function(){return!1};let c,r=!1,i=[];const e={'EMEF Chequer Buchaim':{description:'FAZENDA SAO JOAO 1º DISTRITO, SN ESTRADA DOS GALPOES. 96180-000 Camaquã - RS',phone:'(51) 3671-4034',image:'/pluviometros/schools/emef chequer buchaim.jpg',map_coords:{x:2275,y:2190}},'EMEF 15 de Novembro':{description:'SANTA AUTA 5 DISTRITO, S/N INTERIOR. 96180-000 Camaquã - RS',phone:'(51) 99780-2883',image:'/pluviometros/schools/emef 15 de novembro.jpg',map_coords:{x:1567,y:1480}},'EMEF Alfredo Jacobsen':{description:'BOA VISTA - 8º DISTRITO, INTERIOR. 96180-000 Camaquã - RS.',phone:'(51) 99797-0234',image:'/pluviometros/schools/emef alfredo jacobsen.jpg',map_coords:{x:1580,y:1888}},'EMEF Ana Tomázia Ribeiro':{description:'VITORIANO JOSE CENTENO, 613 CARVALHO BASTOS. 96180-000 Camaquã - RS.',phone:'(51) 3671-3630',image:'/pluviometros/schools/emef ana tomazia.jpg',map_coords:{x:2451,y:2345}},'EMEF Bento Francisco Dias':{description:'RUA MIGUEL LOPES DE ALMEIDA, 160 JARDIM. 96180-000 Camaquã - RS.',phone:'(51) 3671-0646',image:'/pluviometros/schools/emef bento francisco dias.jpg',map_coords:{x:2124,y:2499}},'EMEF Boaventura Cardoso da Silva':{description:'RUA SAO PAULO, S/N SAO CARLOS. 96180-000 Camaquã - RS.',phone:'(51) 99811-3100',image:'/pluviometros/schools/emef boaventura cardoso.jpg',map_coords:{x:2762,y:2202}},'EMEF Cândido Rodrigues Freitas':{description:'BR 116 - KM 394, S/N DISTRITO INDUSTRIAL. 96180-000 Camaquã - RS.',phone:'(51) 98197-0334',image:'/pluviometros/schools/emef candido rodrigues de freitas.jpg',map_coords:{x:2475,y:2389}},'EMEF Érico Veríssimo':{description:'ESTRADA MATO DOS CASTELHANOS, 256 AP 0011. INTERIOR. 96180-000 Camaquã - RS.',phone:'(51) 98468-7822',image:'/pluviometros/schools/emef erico verissimo.jpg',map_coords:{x:1884,y:786}},'EMEF João Beckel':{description:'QUERENCIA 8º DISTRITO, INTERIOR. 96180-000 Camaquã - RS.',phone:'(51) 9664-3733',image:'/pluviometros/schools/emef joao beckel.jpg',map_coords:{x:1999,y:1804}},'EMEF Marina de Godoy Netto':{description:'RUA SAO BORJA, 101 GETULIO VARGAS. 96180-000 Camaquã - RS.',phone:'(51) 3671-9670',image:'/pluviometros/schools/emef marina de godoy netto.jpg',map_coords:{x:2233,y:2512}},'EMEF Mário Centeno Crespo':{description:'PACHECA - 6º DISTRITO, S/N 6º DISTRITO. 96180-000 Camaquã - RS.',phone:'(51) 99779-9534',image:'/pluviometros/schools/emef mario centeno crespo.jpg',map_coords:{x:2377,y:4370}},'EMEF Osvaldo Aranha':{description:'RUA CRUZ ALTA, 1338 VIEGAS. 96180-000 Camaquã - RS.',phone:'(51) 3671-4559',image:'/pluviometros/schools/emef osvaldo aranha.jpg',map_coords:{x:2143,y:2533}},'EMEF Otto Laufer':{description:'ESTRADA DO BONITO, S/N 4º DISTRITO. VILA BOTAFOGO. 96181-000 Camaquã - RS.',phone:'(51) 99591-8954',image:'/pluviometros/schools/emef otto laufer.jpg',map_coords:{x:2397,y:1536}},'EMEF Santo Antônio':{description:'CAPELA SANTO ANTONIO, S/N PROXIMO A IGREJA. INTERIOR. 96180-000 Camaquã - RS.',phone:'(51) 98055-9130',image:'/pluviometros/schools/emef santo antonio.jpg',map_coords:{x:1580,y:2194}},'EMEF Sepé Tiaraju':{description:'RUA OTAVIO JOB, 480 PREDIO. SANTA MARTA. 96180-000 Camaquã - RS.',phone:'(51) 3692-3316',image:'/pluviometros/schools/emef sepe tiaraju.jpg',map_coords:{x:2180,y:2295}}},d={'EMEF Chequer Buchaim':'#000000','EMEF 15 de Novembro':'#0000AA','EMEF Alfredo Jacobsen':'#669900','EMEF Ana Tomázia Ribeiro':'#00AAAA','EMEF Bento Francisco Dias':'#993333','EMEF Boaventura Cardoso da Silva':'#AA00AA','EMEF Cândido Rodrigues Freitas':'#663300','EMEF Érico Veríssimo':'#204D05','EMEF João Beckel':'#555555','EMEF Marina de Godoy Netto':'#5555FF','EMEF Mário Centeno Crespo':'#009900','EMEF Osvaldo Aranha':'#ff1b1b','EMEF Otto Laufer':'#FF5555','EMEF Santo Antônio':'#FF55FF','EMEF Sepé Tiaraju':'#BF7D02'},m={'EMEF Chequer Buchaim':'Fazenda São João','EMEF 15 de Novembro':'Sant\'Auta','EMEF Alfredo Jacobsen':'Boa Vista','EMEF Ana Tomázia Ribeiro':'Carvalho Bastos','EMEF Bento Francisco Dias':'Jardim','EMEF Boaventura Cardoso da Silva':'Vila São Carlos','EMEF Cândido Rodrigues Freitas':'Vila São Pedro','EMEF Érico Veríssimo':'Sanga das pedras','EMEF João Beckel':'Capelha Velha','EMEF Marina de Godoy Netto':'Getúlio Vargas','EMEF Mário Centeno Crespo':'Pacheca','EMEF Osvaldo Aranha':'Viégas','EMEF Otto Laufer':'Vila Bota Fogo','EMEF Santo Antônio':'Capela Santo Antônio','EMEF Sepé Tiaraju':'São João'};function p(o){const e=m[o].toUpperCase();return o=o.toUpperCase(),''===e?o:`${o} (${e})`}function n(e){const a=Object.fromEntries(Object.entries(e).filter((([o,e])=>e.length>0))),n=[...new Set(Object.values(a).flat().map((o=>o.date)))].sort(((o,e)=>new Date(o)-new Date(e))),t=n.map((function(o){const[e,a,n]=o.split('-');return`${n}/${a}/${e}`})),i=Object.keys(a).map((o=>({label:o,data:n.map((e=>{const n=a[o].find((o=>o.date===e));return n&&0!==n.amount?n.amount:null})),borderColor:d[o],backgroundColor:'rgba(0,0,0,0)',fill:!1,spanGaps:!0}))),r=document.getElementById('q').getContext('2d');o&&o.destroy(),o=new Chart(r,{type:'line',data:{labels:t,datasets:i},options:{responsive:!0,title:{display:!0,text:'Dados de chuva'},tooltips:{mode:'index',intersect:!1},hover:{mode:'nearest',intersect:!0},scales:{x:{display:!0,title:{display:!0,text:'Data'}},y:{display:!0,title:{display:!0,text:'Quantidade'}}}}})}window.onload=async function(){const a=document.getElementById('aq'),s=document.getElementById('ar'),m=document.getElementById('ax'),l=document.getElementById('ab'),E=document.getElementById('bf'),A=(document.getElementById('z'),document.getElementById('p')),f=document.getElementById('s'),S=document.getElementById('k'),h=document.getElementById('an'),F=document.getElementById('ba'),g=document.getElementById('aa'),O=document.getElementById('bg'),R=document.getElementById('r'),M=document.getElementById('at'),T=document.getElementById('ap'),v=document.getElementById('o'),I=document.getElementById('bb'),C=document.getElementById('av');function D(o){const a=e[o];document.getElementById('as').textContent=o,document.getElementById('x').textContent=a.description,document.getElementById('bd').textContent=a.phone,document.getElementById('ai').src=a.image}for(const o in e){const a=e[o];if(a.hasOwnProperty('map_coords')){const e=a.map_coords,n=document.createElement('div');n.classList.add('marker');const t=e.y/5788*650-20;n.style.left=e.x/4253*477-7.5+'px',n.style.top=`${t}px`,n.addEventListener('mouseover',(()=>{document.getElementById('ai').alt='Carregando...',D(o)})),C.appendChild(n)}}if('1'===u.get('login')){c=(await t.getSchools()).schools;const o=localStorage.getItem('rainDataToken'),e=localStorage.getItem('rainDataUsername');if(o){t.token=o;try{i=(await t.getAllowedSchools()).allowed_schools,r=!0,s.innerHTML=`Sair de <strong>${e}</strong>`,N(),x(i)}catch(o){localStorage.removeItem('rainDataToken'),localStorage.removeItem('rainDataUsername'),t.token=null,r=!1,N()}}s.style.removeProperty('display')}async function y(e,a,i){try{I.textContent='...';const r=(await t.searchRainDataRange(e,a)).schools_data_range;Object.values(r).every((o=>0===o.length))?(o&&(o.destroy(),o=null),document.getElementById('q').style.display='none',document.getElementById('au').style.removeProperty('padding-bottom'),I.textContent=`No mês de ${O.options[O.selectedIndex].text}, não há dados de chuva.`):(document.getElementById('q').style.display='block',document.getElementById('au').style.paddingBottom='21px',n(r)),function(o,e){for(;h.rows.length>1;)h.deleteRow(1);const a=new Date(e,O.selectedIndex+1,0).getDate(),n=h.rows[0];for(;n.cells.length>1;)n.deleteCell(1);for(let o=1;o<=a;o++)n.insertCell(o).textContent=`${o.toString().padStart(2,'0')}/${O.options[O.selectedIndex].value}`;let t=0,i=Array(a+1).fill(0),r=Array(a+1).fill(0);for(const[e,n]of Object.entries(o)){const o=h.insertRow(),s=o.insertCell(0);s.textContent=p(e),s.style.color=d[e];for(let e=1;e<=a;e++)o.insertCell(e).textContent='---';for(const a of n){const n=new Date(a.date);n.setDate(n.getDate()+1);const s=n.getDate(),c=o.cells[s];c.textContent=a.amount>0?a.amount+' mm':'---',c.style.color=d[e],''!==a.note&&(c.setAttribute('rainpopup',a.note),c.classList.add('hasPopup')),a.amount>0&&(i[s]+=a.amount,r[s]++,1===r[s]&&t++)}}const s=Array(a+1).fill(0);for(let o=1;o<=a;o++)r[o]>0&&(s[o]=(i[o]/r[o]).toFixed(2));let c;if(0===t)c=`No mês de ${O.options[O.selectedIndex].text}, não há dados de chuva.`;else{const o=s.filter((o=>o>0)).reduce(((o,e)=>o+parseFloat(e)),0)/t;c=`Mês: ${O.options[O.selectedIndex].text} - Quantidade de dias chuvosos: ${t}; Média por dia de chuva: ${o.toFixed(2)}mm.`}I.textContent=c}(r,i),function(o){for(;F.rows.length>1;)F.deleteRow(1);for(const[e,a]of Object.entries(o)){let o=0,n=0;for(const e of a)e.amount>0&&(o+=e.amount,n++);const t=n>0?(o/n).toFixed(2)+' mm':'---',i=F.insertRow(),r=i.insertCell(0);r.textContent=p(e),r.style.color=d[e];const s=i.insertCell(1);s.textContent=t;const c=i.insertCell(2);c.textContent=n>0?n:'---','---'!==t&&(s.style.color=d[e],c.style.color=d[e])}}(r),function(){const o=h.querySelectorAll('td'),e=document.getElementById('ae');o.forEach((o=>{o.addEventListener('mouseover',(function(a){const n=o.getAttribute('rainpopup');n?(e.textContent=n,e.style.display='block',e.style.left=`${a.pageX+10}px`,e.style.top=`${a.pageY+10}px`):e.style.display='none'})),o.addEventListener('mousemove',(function(o){e.style.left=`${o.pageX+10}px`,e.style.top=`${o.pageY+10}px`})),o.addEventListener('mouseout',(function(){e.style.display='none'}))}))}()}catch(o){}}function b(){a.style.display='none',l.style.display='none'}function N(){A.style.display=r?'flex':'none'}function w(o){l.style.display='inline-block',l.textContent=o}function x(o){R.innerHTML='';for(const e of o){const o=document.createElement('option');o.value=e,o.textContent=e,R.appendChild(o)}}f.onclick=async function(){const o=g.value,e=O.value,a=`${o}-${e}-01`,n=new Date(o,e,0).toISOString().split('T')[0];await y(a,n,o)},S.onclick=async function(){const o=M.value,e=parseFloat(T.value.replace(',','.')),a=v.value,n=R.value;await async function(o,e,a,n){try{await t.setRainData(o,e,a,n),alert('Dados de chuva definidos com sucesso')}catch(o){}}(n,o,e,a)},s.onclick=function(){r?async function(){try{await t.logout(),s.textContent='FAZER LOGIN',r=!1,i=[],N(),R.innerHTML='',localStorage.removeItem('rainDataToken'),localStorage.removeItem('rainDataUsername')}catch(o){}}():a.style.display='flex'},m.onclick=function(){!async function(){const o=document.getElementById('u'),e=document.getElementById('af'),a=o.value.trim(),n=e.value.trim();if(a&&n)try{await t.login(a,n),b(),s.innerHTML=`Sair de <strong>${a}</strong>`,r=!0,N(),localStorage.setItem('rainDataToken',t.token),localStorage.setItem('rainDataUsername',a),o.value='',e.value='',i=(await t.getAllowedSchools()).allowed_schools,x(i)}catch(o){w(o.message)}else w('Por favor, preencha ambos os campos.')}()},E.onclick=function(){b()},window.onclick=function(o){o.target===a&&b()},D('EMEF Érico Veríssimo'),await y('2025-09-01','2025-09-30','2025'),N()};
